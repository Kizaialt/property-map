<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    body { margin:0; font-family: system-ui, Arial; }
    #wrap { display:flex; height:100vh; }
    #map { flex:1; }
    #panel { width:360px; max-width:90vw; border-left:1px solid #e5e5e5; padding:12px; overflow:auto; background:#fff; }
    .item { padding:10px; border:1px solid #eee; border-radius:10px; margin-bottom:10px; cursor:pointer; }
    .muted { color:#666; font-size:12px; }
    input, select { width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; margin:6px 0 12px; }
  </style>
</head>
<body>
<div id="wrap">
  <div id="map"></div>
  <div id="panel">
    <h3 style="margin:0 0 10px;">Listings</h3>

    <label class="muted">Search</label>
    <input id="q" placeholder="Search by name / location / id" />

    <label class="muted">Filter by Status</label>
    <select id="status"><option value="">All</option></select>

    <div id="list"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiCuH3dh5VUFid0yWs8uaFmkqbjDTX47y-ixvibwyv0OzaWVx1cUosgWH-la9AYhNjSkSMheP5DNQKKu-Hoq8_uuXKQmZnL1kWQs78aqrzUMhFyPYKcGSx_ej1Ean6rYnmLnngyYuaPEoVFfaS3UbO7w10wkmZ9GiOMDW8XK1cgiwkwcAiJ5rVpeIuJJvn2p5Jn8meLbDBBmnM0RzEi_mOf3biyDL59mUY8EQYV6KfZbHPCAGuBWMMVDWgKjUN_utMxX6vxYc2YNArCqE5M_-hT-f5XUg&lib=MWmJCaLoe2GY5RYMSwbuSdreUnuxCpyAE";

  const map = L.map("map").setView([47.918, 106.917], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const qEl = document.getElementById("q");
  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("list");

  let all = [];
  let layer = L.layerGroup().addTo(map);

  function escapeHtml(s){return String(s ?? "").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));}

  function renderStatusOptions(items){
    const set = new Set(items.map(x => (x.status||"").trim()).filter(Boolean));
    statusEl.innerHTML = '<option value="">All</option>' + [...set].sort().map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
  }

  function matches(item, q, st){
    if (st && String(item.status).trim() !== st) return false;
    if (!q) return true;
    const hay = [item.propertyId, item.nershil, item.location, item.torol, item.uhTorol].join(" ").toLowerCase();
    return hay.includes(q.toLowerCase());
  }

  function show(item){
    map.setView([item.lat, item.lng], 14);
    L.popup()
      .setLatLng([item.lat, item.lng])
      .setContent(`
        <div style="min-width:220px">
          <div style="font-weight:700">${escapeHtml(item.nershil || item.propertyId)}</div>
          <div class="muted">${escapeHtml(item.location||"")}</div>
          ${item.une ? `<div><b>Үнэ:</b> ${escapeHtml(item.une)}</div>` : ""}
          ${item.tureesUne ? `<div><b>Түрээс:</b> ${escapeHtml(item.tureesUne)}</div>` : ""}
          ${item.uneguiLink ? `<div><a href="${escapeHtml(item.uneguiLink)}" target="_blank">Open link</a></div>` : ""}
          <div class="muted" style="margin-top:6px">(${item.lat.toFixed(5)}, ${item.lng.toFixed(5)})</div>
        </div>
      `)
      .openOn(map);
  }

  function render(items){
    listEl.innerHTML = "";
    layer.clearLayers();

    if (!items.length){
      listEl.innerHTML = `<div class="muted">No matches.</div>`;
      return;
    }

    const bounds = [];
    for (const item of items){
      const m = L.marker([item.lat, item.lng]).addTo(layer);
      m.on("click", () => show(item));
      bounds.push([item.lat, item.lng]);

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="font-weight:700">${escapeHtml(item.nershil || item.propertyId)}</div>
        <div class="muted">${escapeHtml(item.location||"")}</div>
        <div class="muted">${escapeHtml(item.propertyId||"")}</div>
      `;
      div.addEventListener("click", () => show(item));
      listEl.appendChild(div);
    }

    if (bounds.length) map.fitBounds(bounds, { padding:[40,40] });
  }

  function apply(){
    const q = qEl.value.trim();
    const st = statusEl.value;
    render(all.filter(x => matches(x, q, st)));
  }

  async function load(){
    const res = await fetch(API_URL, { cache:"no-store" });
    all = await res.json();
    renderStatusOptions(all);
    apply();
  }

  qEl.addEventListener("input", apply);
  statusEl.addEventListener("change", apply);

  load().catch(err => {
    listEl.innerHTML = `<div style="color:#b00">Failed to load data: ${escapeHtml(err.message)}</div>`;
  });
</script>
</body>
</html>
