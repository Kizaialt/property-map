<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <title>Property Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; }
    #wrap { display:flex; height:100vh; }
    #map { flex:1; }
    #panel {
      width:360px;
      max-width:90vw;
      border-left:1px solid #e5e5e5;
      padding:12px;
      overflow:auto;
      background:#fff;
    }
    h3 { margin:0 0 10px; }
    .item {
      padding:10px;
      border:1px solid #eee;
      border-radius:10px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .muted { color:#666; font-size:12px; }
    input, select {
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ddd;
      margin:6px 0 12px;
    }
  </style>
</head>

<body>
<div id="wrap">
  <div id="map"></div>

  <div id="panel">
    <h3>“Æ–ª —Ö”©–¥–ª”©—Ö–∏–π–Ω –∂–∞–≥—Å–∞–∞–ª—Ç</h3>

    <label class="muted">–•–∞–π—Ö</label>
    <input id="q" placeholder="–ù—ç—Ä—à–∏–ª / –ë–∞–π—Ä—à–∏–ª / ID" />

    <label class="muted">–¢”©—Ä”©–ª</label>
    <select id="type">
      <option value="">–ë“Ø–≥–¥</option>
      <option value="–±–æ—Ä–ª—É—É–ª–∞—Ö">–ë–æ—Ä–ª—É—É–ª–∞—Ö</option>
      <option value="—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö">–¢“Ø—Ä—ç—ç—Å–ª—ç—Ö</option>
      <option value="—Ö–æ—ë—É–ª–∞–∞">2 –£—É–ª–∞–∞</option>
    </select>

    <div id="list"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // üî¥üî¥üî¥ REPLACE THIS WITH YOUR APPS SCRIPT WEB APP URL üî¥üî¥üî¥
  const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgrNwBSG8lWMKFRVQ2SdSMEwB2xUMZkwHlTOxxpTEGzCPsD56Siy_5cZmaA56xt5HctfjD5p3GIuA3b9FFxuZwAf3ieHZtyjctFjGKlh-W70xgdD4D91w7_YqFOT14mzVg0jz9dHbRBqvayRs3WKRA0UNODubjxqnTMz0bZqG8x8yiG6dTno92ezXha_gXH1msUsbiIUgYDIolcUijH4sOeN4HoIf4nXhTQfiv7PXehPs7njTqULQQQHCvu3AOtYt62O3BOABIoW3-pweoBlSEuTZlfPg&lib=MWmJCaLoe2GY5RYMSwbuSdreUnuxCpyAE";

  // ---------- MAP ----------
  const map = L.map("map").setView([47.918, 106.917], 11);

  const cleanMap = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    { maxZoom:19, attribution:"¬© OpenStreetMap" }
  ).addTo(map);

  const satelliteMap = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    { maxZoom:19, attribution:"¬© Esri" }
  );

  L.control.layers(
    { "Clean map": cleanMap, "Satellite": satelliteMap },
    null,
    { position:"topright" }
  ).addTo(map);

  // ---------- ICONS ----------
  const ICONS = {
    "–±–æ—Ä–ª—É—É–ª–∞—Ö": "red",
    "—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö": "green",
    "—Ö–æ—ë—É–ª–∞–∞": "blue"
  };

  function icon(color){
    return new L.Icon({
      iconUrl:`https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
      shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize:[25,41],
      iconAnchor:[12,41],
      popupAnchor:[1,-34]
    });
  }

  const ICON_CACHE = {
    red: icon("red"),
    green: icon("green"),
    blue: icon("blue")
  };

  // ---------- HELPERS ----------
  const escapeHtml = s =>
    String(s ?? "").replace(/[&<>"']/g,c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[c]));

  const listEl = document.getElementById("list");
  const qEl = document.getElementById("q");
  const typeEl = document.getElementById("type");

  let all = [];
  let layer = L.layerGroup().addTo(map);

  function popup(item){
    return `
      <div style="min-width:240px">
        <div style="font-weight:700">${escapeHtml(item.nershil || item.propertyId)}</div>
        <div class="muted">${escapeHtml(item.location||"")}</div>
        <hr>
        <div><b>–¢”©—Ä”©–ª:</b> ${escapeHtml(item.torol)}</div>
        ${item.m2 ? `<div><b>–¢–∞–ª–±–∞–π:</b> ${item.m2} –º¬≤</div>` : ""}
        ${item.une ? `<div><b>“Æ–Ω—ç:</b> ${Number(item.une).toLocaleString()} ‚ÇÆ</div>` : ""}
        ${item.tureesUne ? `<div><b>–¢“Ø—Ä—ç—ç—Å:</b> ${Number(item.tureesUne).toLocaleString()} ‚ÇÆ</div>` : ""}
        <div style="margin-top:6px">
          ${item.lift ? "üõó –õ–∏—Ñ—Ç " : ""}
          ${item.garaj ? "üöó –ì–∞—Ä–∞–∂" : ""}
        </div>
        ${item.uneguiLink ? `<div style="margin-top:8px">
          <a href="${escapeHtml(item.uneguiLink)}" target="_blank">Unegui –¥—ç—ç—Ä –Ω—ç—ç—Ö ‚Üí</a>
        </div>` : ""}
      </div>`;
  }

  function render(items){
    listEl.innerHTML = "";
    layer.clearLayers();

    if (!items.length){
      listEl.innerHTML = `<div class="muted">–ò–ª—ç—Ä—Ü –æ–ª–¥—Å–æ–Ω–≥“Ø–π</div>`;
      return;
    }

    const bounds = [];

    for (const item of items){
      const color = ICONS[item.torol] || "blue";
      const m = L.marker([item.lat, item.lng], { icon: ICON_CACHE[color] })
        .addTo(layer)
        .bindPopup(popup(item));

      m.on("click",()=>map.setView([item.lat,item.lng],14));
      bounds.push([item.lat,item.lng]);

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div style="font-weight:700">${escapeHtml(item.nershil||item.propertyId)}</div>
        <div class="muted">${escapeHtml(item.location||"")}</div>
        <div class="muted">${escapeHtml(item.torol)}</div>
      `;
      div.onclick = ()=> {
        map.setView([item.lat,item.lng],14);
        m.openPopup();
      };
      listEl.appendChild(div);
    }

    map.fitBounds(bounds,{ padding:[40,40], maxZoom:14 });
  }

  function apply(){
    const q = qEl.value.toLowerCase().trim();
    const t = typeEl.value;
    render(all.filter(x=>{
      if (t && x.torol !== t) return false;
      if (!q) return true;
      return [
        x.propertyId,x.nershil,x.location
      ].join(" ").toLowerCase().includes(q);
    }));
  }

  qEl.oninput = apply;
  typeEl.onchange = apply;

  async function load(){
    const res = await fetch(API_URL,{ cache:"no-store" });
    all = await res.json();
    apply();
  }

  load().catch(err=>{
    listEl.innerHTML = `<div style="color:#b00">Error: ${escapeHtml(err.message)}</div>`;
  });

  // ---------- LEGEND ----------
  const legend = L.control({ position:"bottomright" });
  legend.onAdd = ()=>{
    const d = L.DomUtil.create("div");
    d.style.background="white";
    d.style.padding="8px";
    d.style.borderRadius="8px";
    d.innerHTML = `
      <div><span style="color:red">‚¨§</span> –ë–æ—Ä–ª—É—É–ª–∞—Ö</div>
      <div><span style="color:green">‚¨§</span> –¢“Ø—Ä—ç—ç—Å–ª—ç—Ö</div>
      <div><span style="color:blue">‚¨§</span> –•–æ—ë—É–ª–∞–∞</div>
    `;
    return d;
  };
  legend.addTo(map);
</script>
</body>
</html>
