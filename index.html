<!doctype html>
<html lang="mn">
<head>
<meta charset="utf-8"/>
<title>Property Map</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
:root{
  --bg:#fff;--text:#111;--muted:#6b7280;--border:#e5e7eb;
  --shadow:0 10px 25px rgba(0,0,0,.12);
}
html,body{margin:0;height:100%;font-family:system-ui}
#map{height:100vh;width:100vw}

/* Floating panel */
.panel{
  position:fixed;right:16px;top:110px;width:320px;
  background:#fff;border:1px solid var(--border);
  border-radius:14px;box-shadow:var(--shadow);z-index:9999;
}
.panelHeader{padding:12px;font-weight:900;border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.panelBody{padding:12px}
.panelFooter{padding:12px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:space-between}
.hidden{display:none}

.input,.select{
  width:100%;padding:10px;border-radius:12px;border:1px solid var(--border);
  font-weight:800;margin-bottom:10px
}
.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:900;cursor:pointer}

/* Map toggle */
.mapToggle{
  position:fixed;left:14px;top:140px;width:44px;height:44px;
  border-radius:999px;border:1px solid var(--border);
  background:#fff;box-shadow:var(--shadow);font-weight:900;cursor:pointer;
}

/* Marker label */
.pinWrap{display:flex;gap:6px;align-items:flex-start}
.pinDot{width:16px;height:16px;border-radius:999px;margin-top:4px;border:2px solid #fff}
.red{background:#ef4444}.green{background:#22c55e}.blue{background:#3b82f6}
.pinLabel{background:rgba(255,255,255,.95);padding:6px 8px;border-radius:10px;box-shadow:var(--shadow)}
.pinTitle{font-size:12px;font-weight:900;white-space:nowrap}
.pinSub{font-size:11px;color:var(--muted);font-weight:800}

/* Popup */
.popupTop{font-weight:900;font-size:14px}
.popupChips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.chip{padding:6px 10px;border-radius:12px;font-size:12px;font-weight:900;border:1px solid var(--border)}
.chip.red{background:#fee2e2}.chip.green{background:#dcfce7}.chip.blue{background:#dbeafe}
.chip.orange{background:#ffedd5}.chip.gray{background:#f3f4f6}
.popupHint{font-size:11px;color:var(--muted);margin-top:8px}

/* Drawer */
.drawer{
  position:fixed;right:16px;top:110px;bottom:16px;width:420px;
  background:#fff;border:1px solid var(--border);
  border-radius:14px;box-shadow:var(--shadow);display:none;z-index:10000;
}
.drawerHeader{padding:14px;border-bottom:1px solid var(--border);text-align:center;font-weight:900}
.drawerBody{padding:14px;overflow:auto;height:calc(100% - 60px)}
.section{font-weight:900;margin:18px 0 8px}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.stat{border:1px solid var(--border);border-radius:12px;padding:10px}
.statLabel{font-size:11px;color:var(--muted);font-weight:900}
.statValue{font-size:13px;font-weight:900;margin-top:6px}
.row{display:flex;justify-content:space-between;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px;font-weight:900}
.checks{display:flex;gap:16px;margin-top:10px}
.box{width:16px;height:16px;border:1px solid #ccc;border-radius:4px;display:inline-flex;align-items:center;justify-content:center}
.checked{background:#111;color:#fff}
</style>
</head>

<body>
<div id="map"></div>
<button class="mapToggle" id="mapToggle">üõ∞</button>

<div class="panel">
  <div class="panelHeader">
    PROPERTY_INVENTORY
    <button class="btn" id="collapseBtn">‚ò∞</button>
  </div>
  <div class="panelBody" id="panelBody">
    <input class="input" list="bairshilList" id="bairshilSearch" placeholder="–ë–∞–π—Ä—à–∏–ª"/>
    <datalist id="bairshilList"></datalist>

    <select class="select" id="type">
      <option value="">–¢”©—Ä”©–ª (–ë“Ø–≥–¥)</option>
      <option value="–±–æ—Ä–ª—É—É–ª–∞—Ö">–ë–æ—Ä–ª—É—É–ª–∞—Ö</option>
      <option value="—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö">–¢“Ø—Ä—ç—ç—Å–ª—ç—Ö</option>
      <option value="—Ö–æ—ë—É–ª–∞–∞">–•–æ—ë—É–ª–∞–∞</option>
    </select>
  </div>
</div>

<div class="drawer" id="drawer">
  <div class="drawerHeader" id="drawerTitle"></div>
  <div class="drawerBody" id="drawerBody"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhOSG9iK7anYVUc54lw7z7Ze9g-sgvWTjW9OM-0fuVz-mCgi_3AF2SHS4RKUKSSx-qFYVeSzWU7G_8AebpMUgEMm9d3bGAr6NzRzt-653eaNWnrY6QKS42v5EKEgXsjtDnVunD9J9UQsE08i2W-uxhlRoudgEkqgbVZt5NfAS_D2p1H15szKh10bv6025VvoQWZUpWcH8xeOiYuykg-sMNBsPxGY04wNINO9RPHlHuMKW2MT8TYCscLzgzRfDW1RzUQRxCPH5drzJAzNT5pCPinm_SFVg&lib=MWmJCaLoe2GY5RYMSwbuSdreUnuxCpyAE";

/* MAP */
const map = L.map("map").setView([47.918,106.917],11);
const clean = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const sat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
let satOn=false;
document.getElementById("mapToggle").onclick=()=>{
  satOn=!satOn;
  satOn?(map.removeLayer(clean),map.addLayer(sat)):(map.removeLayer(sat),map.addLayer(clean));
};

const markers = L.markerClusterGroup();
map.addLayer(markers);

/* HELPERS */
const esc=s=>String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
const torolColor=t=>t==="–±–æ—Ä–ª—É—É–ª–∞—Ö"?"red":t==="—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö"?"green":"blue";
const torolLabel=t=>t==="—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö"?"—Ç“Ø—Ä—ç—ç—Å":t;
const chip=(t,c)=>t?`<span class="chip ${c}">${esc(t)}</span>`:"";

/* MARKER */
function labeledMarker(item){
  const html=`
  <div class="pinWrap">
    <div class="pinDot ${torolColor(item.torol)}"></div>
    <div class="pinLabel">
      <div class="pinTitle">${esc(item.nershil)}</div>
      <div class="pinSub">${esc(item.uhTorol||"")}</div>
    </div>
  </div>`;
  return L.marker([item.lat,item.lng],{icon:L.divIcon({html,className:""})});
}

/* POPUP */
function popupHTML(item){
  return `
  <div>
    <div class="popupTop">${esc(item.nershil)}</div>
    <div class="popupChips">
      ${chip(item.uhTorol,"blue")}
      ${chip(torolLabel(item.torol),torolColor(item.torol))}
      ${chip(item.bairshil,"orange")}
      ${chip(item.m2?item.m2+" –º¬≤":"","gray")}
    </div>
    <div class="popupHint">Click to open details ‚Üí</div>
  </div>`;
}

/* DRAWER */
function openDrawer(i){
  const d=document.getElementById("drawer");
  d.style.display="block";
  drawerTitle.textContent=i.nershil;

  drawerBody.innerHTML=`
  <div class="section">“Æ–Ω–¥—Å—ç–Ω –º—ç–¥—ç—ç–ª—ç–ª</div>
  <div class="stats">
    <div class="stat"><div class="statLabel">–ì–∞–∑–∞—Ä M¬≤</div><div class="statValue">${i.gazarM2||"-"}</div></div>
    <div class="stat"><div class="statLabel">M¬≤</div><div class="statValue">${i.m2||"-"}</div></div>
    <div class="stat"><div class="statLabel">“Æ–Ω—ç</div><div class="statValue">${i.une?i.une.toLocaleString()+" ‚ÇÆ":"-"}</div></div>
    <div class="stat"><div class="statLabel">M¬≤ “Ø–Ω—ç–ª–≥—ç—ç</div><div class="statValue">${i.m2Uneleg||"-"}</div></div>
  </div>

  <div class="row"><span>”®—Ä”©”©</span><span>${i.uruu||"-"}</span></div>
  <div class="row"><span>–î–∞–≤—Ö–∞—Ä / –ë–∞–π—Ä –î–∞–≤—Ö–∞—Ä</span><span>${i.davhar||"-"} / ${i.bairDavhar||"-"}</span></div>

  <div class="section">–¢”©–ª–±”©—Ä–∏–π–Ω –Ω”©—Ö—Ü”©–ª</div>
  <div>${esc(i.tolborNohtsol||"")}</div>

  <div class="section">–û–Ω—Ü–ª–æ–≥</div>
  <div class="checks">
    <div><span class="box ${i.garaj?"checked":""}">${i.garaj?"‚úì":""}</span> –ì–∞—Ä–∞–∂</div>
    <div><span class="box ${i.lift?"checked":""}">${i.lift?"‚úì":""}</span> –õ–∏—Ñ—Ç</div>
  </div>

  <div class="section">–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π —Ç–∞–π–ª–±–∞—Ä</div>
  <div>${esc(i.delgerenguiTailbar||"")}</div>`;
}

/* LOAD */
fetch(API_URL).then(r=>r.json()).then(data=>{
  const list=[...new Set(data.map(x=>x.bairshil).filter(Boolean))];
  bairshilList.innerHTML=list.map(v=>`<option value="${esc(v)}">`).join("");

  data.forEach(i=>{
    const m=labeledMarker(i);
    m.bindPopup(popupHTML(i));
    m.on("popupopen",e=>{
      e.popup.getElement().onclick=()=>openDrawer(i);
    });
    markers.addLayer(m);
  });
});
</script>
</body>
</html>
