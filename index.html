<!doctype html>
<html lang="mn">
<head>
<meta charset="utf-8"/>
<title>PROPERTY_INVENTORY</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#fff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow:0 10px 25px rgba(0,0,0,.12);
}

html, body {
  margin:0;
  height:100%;
  font-family: Calibri, "Carlito", "Segoe UI", Arial, "Noto Sans", sans-serif;
  color:var(--text);
}

#map{height:100vh;width:100vw}

/* Map toggle */
.mapToggle{
  position:fixed;
  left:14px;
  top:140px;
  width:44px;
  height:44px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#fff;
  box-shadow:var(--shadow);
  cursor:pointer;
  z-index:9999;
  font-weight:900;
}

/* Panel */
.panel{
  position:fixed;
  right:16px;
  top:110px;
  width:340px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:var(--shadow);
  z-index:9999;
  overflow:hidden;
}
.panelHeader{
  padding:12px;
  font-weight:950;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}
.panelBody{padding:12px}
.hidden{display:none}

.input,.select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  font-weight:900;
  font-size:14px;
  margin-bottom:12px;
}
.btn{
  padding:8px 10px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:950;
  cursor:pointer;
}

/* Mapon-style marker */
.maponMarker{
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
}
.maponPin{
  width:22px;
  height:22px;
  filter: drop-shadow(0 2px 6px rgba(0,0,0,.25));
}
.maponText,.maponSub{
  font-weight:950;
  font-size:12px;
  line-height:1.15;
  color:#111;
  text-shadow:
    0 1px 0 rgba(255,255,255,.9),
    0 0 6px rgba(255,255,255,.7);
}
.maponSub{margin-top:2px}

/* Popup */
.popupTop{font-weight:950;font-size:14px}
.popupChips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.chip{
  padding:7px 10px;
  border-radius:12px;
  font-size:12px;
  font-weight:950;
  border:1px solid var(--border);
}
.chip.red{background:#fee2e2}
.chip.green{background:#dcfce7}
.chip.blue{background:#dbeafe}
.chip.orange{background:#ffedd5}
.chip.gray{background:#f3f4f6}
.popupHint{font-size:12px;color:var(--muted);margin-top:10px}

/* Drawer */
.drawer{
  position:fixed;
  right:16px;
  top:110px;
  bottom:16px;
  width:420px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:var(--shadow);
  display:none;
  z-index:10000;
}
.drawerHeader{
  padding:14px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
}
.drawerTitle{
  width:100%;
  text-align:center;
  font-weight:950;
  font-size:16px;
}
.drawerClose{
  border:none;
  background:transparent;
  font-size:18px;
  cursor:pointer;
}
.drawerBody{
  padding:14px;
  overflow:auto;
  height:calc(100% - 60px);
}

.section{
  font-weight:950;
  margin:18px 0 10px;
}
.sectionCenter{
  text-align:center;
}

.stats{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
}
.stat{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
.statLabel{
  font-size:11px;
  color:var(--muted);
  font-weight:900;
}
.statValue{
  font-size:13px;
  font-weight:950;
  margin-top:6px;
}

.row{
  display:flex;
  justify-content:space-between;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  margin-top:10px;
  font-weight:950;
}

.valueNormal{
  font-weight:600;
}

.checks{
  display:flex;
  gap:18px;
  margin-top:10px;
}
.box{
  width:16px;
  height:16px;
  border:1px solid #cbd5e1;
  border-radius:4px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
}
.checked{
  background:#111827;
  color:#fff;
  border-color:#111827;
  font-size:12px;
}
</style>
</head>

<body>
<div id="map"></div>
<button class="mapToggle" id="mapToggle">üõ∞</button>

<div class="panel">
  <div class="panelHeader">
    PROPERTY_INVENTORY
    <button class="btn" id="collapseBtn">‚ò∞</button>
  </div>
  <div class="panelBody" id="panelBody">
    <input class="input" list="bairshilList" id="bairshilSearch" placeholder="–ë–∞–π—Ä—à–∏–ª"/>
    <datalist id="bairshilList"></datalist>

    <select class="select" id="type">
      <option value="">–¢”©—Ä”©–ª (–ë“Ø–≥–¥)</option>
      <option value="–±–æ—Ä–ª—É—É–ª–∞—Ö">–ë–æ—Ä–ª—É—É–ª–∞—Ö</option>
      <option value="—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö">–¢“Ø—Ä—ç—ç—Å</option>
      <option value="—Ö–æ—ë—É–ª–∞–∞">–•–æ—ë—É–ª–∞–∞</option>
    </select>

    <select class="select" id="pay">
      <option value="">–¢”©–ª–±”©—Ä–∏–π–Ω –Ω”©—Ö—Ü”©–ª (–ë“Ø–≥–¥)</option>
    </select>
  </div>
</div>

<div class="drawer" id="drawer">
  <div class="drawerHeader">
    <div class="drawerTitle" id="drawerTitle"></div>
    <button class="drawerClose" id="drawerClose">‚úï</button>
  </div>
  <div class="drawerBody" id="drawerBody"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLhOSG9iK7anYVUc54lw7z7Ze9g-sgvWTjW9OM-0fuVz-mCgi_3AF2SHS4RKUKSSx-qFYVeSzWU7G_8AebpMUgEMm9d3bGAr6NzRzt-653eaNWnrY6QKS42v5EKEgXsjtDnVunD9J9UQsE08i2W-uxhlRoudgEkqgbVZt5NfAS_D2p1H15szKh10bv6025VvoQWZUpWcH8xeOiYuykg-sMNBsPxGY04wNINO9RPHlHuMKW2MT8TYCscLzgzRfDW1RzUQRxCPH5drzJAzNT5pCPinm_SFVg&lib=MWmJCaLoe2GY5RYMSwbuSdreUnuxCpyAE";

/* Map */
const map = L.map("map").setView([47.918,106.917],11);
const clean = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const sat = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
let satOn=false;
mapToggle.onclick=()=>{satOn?(map.removeLayer(sat),map.addLayer(clean)):(map.removeLayer(clean),map.addLayer(sat));satOn=!satOn};

const markersLayer = L.layerGroup().addTo(map);

/* Helpers */
const esc=s=>String(s??"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
const norm=v=>String(v??"").trim().toLowerCase();
const money=v=>v?Number(v).toLocaleString()+" ‚ÇÆ":"-";

function torolPinColor(t){
  t=norm(t);
  if(t==="–±–æ—Ä–ª—É—É–ª–∞—Ö") return "#ef4444";
  if(t==="—Ç“Ø—Ä—ç—ç—Å–ª—ç—Ö"||t==="—Ç“Ø—Ä—ç—ç—Å") return "#22c55e";
  return "#3b82f6";
}

/* Marker */
function labeledMarker(i){
  const sub=[i.m2?i.m2+"m¬≤":"",i.uruu?i.uruu+" ”©—Ä”©”©":""].filter(Boolean).join(" | ");
  const pinSvg=`
    <svg class="maponPin" viewBox="0 0 24 24">
      <path fill="${torolPinColor(i.torol)}" d="M12 2c-3.314 0-6 2.686-6 6 0 4.5 6 14 6 14s6-9.5 6-14c0-3.314-2.686-6-6-6z"/>
      <circle cx="12" cy="8" r="2.6" fill="#fff"/>
    </svg>`;
  return L.marker([i.lat,i.lng],{
    icon:L.divIcon({
      className:"",
      html:`<div class="maponMarker">${pinSvg}<div><div class="maponText">${esc(i.nershil)}</div><div class="maponSub">${esc(sub)}</div></div></div>`,
      iconAnchor:[11,22],
      popupAnchor:[0,-18]
    })
  });
}

/* Popup */
function popupHTML(i){
  return `
    <div class="popupTop">${esc(i.nershil)}</div>
    <div class="popupChips">
      <span class="chip blue">${esc(i.uhTorol||"")}</span>
      <span class="chip">${esc(i.bairshil||"")}</span>
      <span class="chip gray">${i.m2||""} –º¬≤</span>
    </div>
    <div class="popupHint">Click to open details ‚Üí</div>`;
}

/* Drawer */
function openDrawer(i){
  drawer.style.display="block";
  drawerTitle.textContent=i.nershil;

  drawerBody.innerHTML=`
    <div class="section">“Æ–Ω–¥—Å—ç–Ω –º—ç–¥—ç—ç–ª—ç–ª</div>
    <div class="stats">
      <div class="stat"><div class="statLabel">–ì–∞–∑–∞—Ä M¬≤</div><div class="statValue">${i.gazarM2||"-"}</div></div>
      <div class="stat"><div class="statLabel">M¬≤</div><div class="statValue">${i.m2||"-"}</div></div>
      <div class="stat"><div class="statLabel">“Æ–Ω—ç</div><div class="statValue">${money(i.une)}</div></div>
      <div class="stat"><div class="statLabel">M¬≤ “Ø–Ω—ç–ª–≥—ç—ç</div><div class="statValue">${i.m2Uneleg||"-"}</div></div>
    </div>

    <div class="row"><span>”®—Ä”©”©</span><span>${i.uruu||"-"}</span></div>
    <div class="row"><span>–î–∞–≤—Ö–∞—Ä / –ë–∞–π—Ä –î–∞–≤—Ö–∞—Ä</span><span>${i.davhar||"-"} / ${i.bairDavhar||"-"}</span></div>

    <div class="section">–¢”©–ª–±”©—Ä–∏–π–Ω –Ω”©—Ö—Ü”©–ª</div>
    <div class="valueNormal">${esc(i.tolborNohtsol||"-")}</div>

    <div class="section">–û–Ω—Ü–ª–æ–≥</div>
    <div class="checks">
      <div>${i.garaj?'<span class="box checked">‚úì</span>':'<span class="box"></span>'} –ì–∞—Ä–∞–∂</div>
      <div>${i.lift?'<span class="box checked">‚úì</span>':'<span class="box"></span>'} –õ–∏—Ñ—Ç</div>
    </div>

    <div class="section">–¶–æ–Ω—Ö–Ω—ã —á–∏–≥–ª—ç–ª</div>
    <div class="valueNormal">${esc(i.tsonhniiChiglel||"-")}</div>

    <div class="section sectionCenter">–î—ç–ª–≥—ç—Ä—ç–Ω–≥“Ø–π —Ç–∞–π–ª–±–∞—Ä</div>
    <div class="valueNormal" style="white-space:pre-line;">${esc(i.delgerenguiTailbar||"-")}</div>

    <div class="row" style="margin-top:16px;">
      <span>List Agent</span>
      <span>${esc(i.listAgent||"-")}</span>
    </div>
  `;
}

/* Filters */
let ALL=[];
function matches(i){
  if(bairshilSearch.value && norm(i.bairshil)!==norm(bairshilSearch.value)) return false;
  if(type.value && norm(i.torol)!==norm(type.value)) return false;
  if(pay.value && norm(i.tolborNohtsol)!==norm(pay.value)) return false;
  return true;
}
function render(){
  markersLayer.clearLayers();
  ALL.filter(matches).forEach(i=>{
    const m=labeledMarker(i);
    m.bindPopup(popupHTML(i));
    m.on("popupopen",e=>e.popup.getElement().onclick=()=>openDrawer(i));
    markersLayer.addLayer(m);
  });
}

/* Load */
fetch(API_URL).then(r=>r.json()).then(data=>{
  ALL=data.map(x=>({...x,lat:+x.lat,lng:+x.lng}));
  bairshilList.innerHTML=[...new Set(ALL.map(x=>x.bairshil).filter(Boolean))].map(v=>`<option value="${esc(v)}">`).join("");
  pay.innerHTML='<option value="">–¢”©–ª–±”©—Ä–∏–π–Ω –Ω”©—Ö—Ü”©–ª (–ë“Ø–≥–¥)</option>'+[...new Set(ALL.map(x=>x.tolborNohtsol).filter(Boolean))].map(v=>`<option>${esc(v)}</option>`).join("");
  bairshilSearch.oninput=render;
  type.onchange=render;
  pay.onchange=render;
  render();
});
drawerClose.onclick=()=>drawer.style.display="none";
collapseBtn.onclick=()=>panelBody.classList.toggle("hidden");
</script>
</body>
</html>
